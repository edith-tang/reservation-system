@model ReservationSystem.Models.Reservation.CreateReservation

@{
    ViewData["Title"] = "Make a Reservation";

    var firstDay = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1).ToShortDateString();
    var lastDay = new DateTime(Model.MaxDate.Year, Model.MaxDate.Month, DateTime.DaysInMonth(Model.MaxDate.Year,
                                                        Model.MaxDate.Month)).ToShortDateString();
    var minDay = DateTime.Today.ToShortDateString();
    var maxDay = Model.MaxDate.ToShortDateString();
}

<h3>Make a Reservation</h3>

<div class="row">
    <div class="col-12">

        <form asp-action="CreateReservation">

            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="row" id="CustInfo">
                <div class="form-group col-3">
                    <label asp-for="Customer.CustFName" class="control-label">First Name</label>
                    <input asp-for="Customer.CustFName" class="form-control" />
                    <span asp-validation-for="Customer.CustFName" class="text-danger"></span>
                </div>
                <div class="form-group col-3">
                    <label asp-for="Customer.CustLName" class="control-label">Last Name</label>
                    <input asp-for="Customer.CustLName" class="form-control" />
                    <span asp-validation-for="Customer.CustLName" class="text-danger"></span>
                </div>
                <div class="form-group col-3">
                    <label asp-for="Customer.CustEmail" class="control-label">Email</label>
                    <input asp-for="Customer.CustEmail" class="form-control" />
                    <span asp-validation-for="Customer.CustEmail" class="text-danger"></span>
                </div>
                <div class="form-group col-3">
                    <label asp-for="Customer.CustPhone" class="control-label">Phone</label>
                    <input asp-for="Customer.CustPhone" class="form-control" />
                    <span asp-validation-for="Customer.CustPhone" class="text-danger"></span>
                </div>
            </div>

            @*<div class="row">
                    <div class="form-group col-6">
                        <label class="control-label">Selecte a date:</label>
                        <input type="text" id="datepicker" class="form-control" autocomplete="off" />
                    </div>
                </div>*@

            <div class="row" id="SelectSitting">
                <div class="form-group col-6">
                    <label class="control-label">Selecte a date:</label>
                    <input asp-for="SelectedDate" type="text" class="form-control" id="Calendar" />
                    <span asp-validation-for="SelectedDate" class="text-danger"></span>
                </div>
                <div class="form-group col-6">
                    <label class="control-label">Select a Sitting:</label>
                    <select asp-for="SelectedSittingId" class="form-control" id="Sittings"></select>
                    <span asp-validation-for="SelectedSittingId" class="text-danger"></span>
                </div>
            </div>

            <div class="row" id="SelectTime">
                @* in line with sc timeslot start time *@
                <div class="form-group col-6">
                    <label class="control-label">Expected Arrival</label>
                    <select asp-for="ExpectedStartTime" type="text" class="form-control" id="StartTimes"></select>
                    <span asp-validation-for="ExpectedStartTime" class="text-danger"></span>
                </div>
                @* in line with sc timeslot duration *@
            <div class="form-group col-6">
                <label class="control-label">Expected Leave</label>
                <select asp-for="ExpectedEndTime" type="text" class="form-control" id="EndTimes"></select>
                <span asp-validation-for="ExpectedEndTime" class="text-danger"></span>
            </div>
            </div>

            <div id="CapacityWarning" hidden style="color: red">Please note: <span id="RemainingCapacity"></span> seats left</div>

            <div class="row" id="ReservationInfo">
                <div class="form-group col-6">
                    @* can't exceed remaining capacity' *@
                    <label asp-for="NumOfGuests" class="control-label">Number of Guests</label>
                    <input asp-for="NumOfGuests" class="form-control" min="1" id="NumOfGuests"/>
                    <span asp-validation-for="NumOfGuests" class="text-danger"></span>
                </div>
                <div class="form-group col-6">
                    <label asp-for="Notes" class="control-label"></label>
                    <input asp-for="Notes" class="form-control" id="notes" />
                    <span asp-validation-for="Notes" class="text-danger"></span>
                </div>
            </div>

            <div class="row">
                <div class="form-group col-6">
                    <input type="submit" value="Create" class="btn btn-primary" />
                </div>
            </div>

        </form>

    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {

    @*<script>
            var reserveddates = ['21-09-30', '21-10-31'];
            $('#datepicker').datepicker({
                beforeShowDay: function (date) {
                    var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
                    return [reserveddates.indexOf(string) == -1]
                }
            });
        </script>*@

    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script>
        $('#Calendar').daterangepicker({
            "singleDatePicker": true,
            "showCustomRangeLabel": false,
            "autoApply": true,
            "locale": {
                    "format": "@Model.SysDateFormat",
                    "separator": " - ",
                    "applyLabel": "Apply",
                    "cancelLabel": "Cancel",
                    "fromLabel": "From",
                    "toLabel": "To",
                    "customRangeLabel": "Custom",
                    "weekLabel": "W",
                    "daysOfWeek": ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                    "monthNames": ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ],
                    "firstDay": 1
                },
                "minDate": "@minDay", "maxDate": "@maxDay"
            }, function () { });
    </script>

    <script>
        $(document).ready(function () {

            //Generate sitting options list for default date selected
            $.ajax({
                type: "GET",
                url: '/Reservation/GetSittingsByDate',
                data: { date: $('#Calendar').val() },
                dataType: "json",
                success: function (response) {
                    if (response.length > 0) {
                        $('#Sittings').append($('<option>', {
                            value: "none", text: '-- Select a Sitting --', selected: true, disabled: true,
                        }));
                        $.each(response, function (i, item) {
                            $('#Sittings').append($('<option>', {
                                value: item.id, text: item.date + " " + item.startTime + "-" + item.endTime + " " + item.scName,
                            }));
                        });
                    }
                },
            });

            //when a date is selected, show the sittings available
            $('#Calendar').on(' change', function () {
                
                $('#Sittings').empty();
                $('#StartTimes').empty();
                $('#EndTimes').empty();

                $.ajax({
                    type: "GET",
                    url: '/Reservation/GetSittingsByDate',
                    data: { date: this.value },
                    dataType: "json",
                    success: function (response) {
                        if (response.length > 0) {
                            $('#Sittings').append($('<option>', {
                                value: "none", text: '-- Select a Sitting --', selected: true, disabled: true,
                            }));
                            $.each(response, function (i, item) {
                                $('#Sittings').append($('<option>', {
                                    value: item.id, text: item.date + " " + item.startTime + "-" + item.endTime + " " + item.scName,
                                }));
                            });
                        }
                    },
                });
            });

            //when a sitting is selected, show the remaining capacity and the start times available
            $('#Sittings').on('change', function () {
                
                $.ajax({
                    type: "GET",
                    url: '/Reservation/GetSittingCapacity',
                    data: { sittingId: this.value },
                    dataType: "json",
                    success: function (response) {
                        $('#CapacityWarning').attr("hidden", false);
                        $('#RemainingCapacity').text(response);
                        $('#NumOfGuests').attr("max", response);
                    },
                });

                $.ajax({
                    type: "GET",
                    url: '/Reservation/GetStartTimes',
                    data: { sittingId: this.value },
                    dataType: "json",
                    success: function (response) {
                        $('#StartTimes').empty();
                        $('#EndTimes').empty();
                        $('#StartTimes').append($('<option>', {
                            value: "none", text: '-- Select a Start Time --', selected: true, disabled: true,
                        }));
                        $.each(response, function (i, item) {
                            $('#StartTimes').append($('<option>', {
                                text: item
                            }));
                        });
                    },
                });
            })

            //when a start time is selected,  show the end times available
            $('#StartTimes').on('change', function () {
                $.ajax({
                    type: "GET",
                    url: '/Reservation/GetEndTimes',
                    data: { sittingId: $('#Sittings').val(), startTime: this.value },
                    dataType: "json",
                    success: function (response) {
                        $('#EndTimes').empty();
                        $('#EndTimes').append($('<option>', {
                            value: "none", text: '-- Select an End Time --', selected: true, disabled: true,
                        }));
                        $.each(response, function (i, item) {
                            $('#EndTimes').append($('<option>', {
                                text: item
                            }));
                        });
                    },
                });
            })

        })
    </script>

    @*<script>
            var sittings = @Json.Serialize(Model.FutureSittings);
            var filter;
            var filteredSittings;
            $('#demo').on('change', function () {
                filter = this.value;
                filteredSittings = sittings.filter(s => s.date == filter);
                $("#sittingsTable").find('tbody').empty();
                filteredSittings.forEach(
                    function (e) {
                        $("#sittingsTable").find('tbody').append($('<tr scope="row">').append($('<td>').text(e.date)));
                    }
                );
            });
        </script>*@


    @*<script src="~/lib/jquery/dist/jquery.min.js"></script>
        <script src="~/js/jquery.amsify.suggestags.js"></script>
        <link href="~/css/amsify.suggestags.css" rel="stylesheet" />
        <script>
            $(document).ready(function () {
                $('input[id="notes"]').amsifySuggestags({
                    type: 'amsify',
                    suggestions: ['Vegetarian', 'Table near window'],
                    printValues: false
                });
            });
        </script>*@

    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
